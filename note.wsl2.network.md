---
id: 5h7y18o5u4dmnxvimluofyr
title: Network
desc: ''
updated: 1762988190075
created: 1762783217759
---

## wsl 网络架构

1. ref: https://learn.microsoft.com/en-us/windows/wsl/networking
2. ref: https://learn.microsoft.com/en-us/windows/wsl/wsl-config

目前官方推出的网络模式

1. NAT mode default mode
   1. NAT网关是一个中介设备，负责网络转换的对象，在虚拟机或私有网络中的设备通过NAT网关访问外部网络
   2. 需要经过虚拟网络接口进行数据包转发，网络接口间通过NAT网关进行转化

        ```bash
                            ┌────────────────────────────┐
                        │        外部网络 (Internet) │
                        └────────────┬───────────────┘
                                    │
                        ┌────────────┴───────────────┐
                        │    Windows 宿主机 (NAT网关) │
                        │  IP: 192.168.1.100 (真实网卡)
                        │  IP: 172.24.240.1 (vEthernet WSL)
                        └────────────┬───────────────┘
                                    │
                        ┌────────────┴───────────────┐
                        │       WSL2 虚拟机实例      │
                        │  IP: 172.24.240.123        │
                        └────────────────────────────┘

        ```

   3. 举例，wsl2访问外部网络：`ping www.baidu.com`
      1. WSL2（172.24.240.123）发出请求 → 目的地：百度公网 IP；
      2. Windows 虚拟网卡 vEthernet (WSL) 捕获；
      3. Windows 执行 NAT 转换，把源地址改为宿主机 IP（192.168.1.100）；
      4. 请求发往外网；
      5. 外网响应返回宿主机 → NAT 反向转换 → 回送给 WSL2。
   4. 问题：NAT示例中外部返回的数据包，是如何正确被送回原始发送方的
      1. 访问路径：`WSL2 (172.28.80.25) → vEthernet(WSL, 172.28.64.1) → NAT 转换 → 宿主机网卡 (192.168.1.100) → 外部网络`
      2. NAT网关会维护内网地址到宿主地址的映射表，内网发送的数据包会被记录映射，并修改源地址为宿主地址，接收到外网数据包时，先进行查表，发现存在映射，则进行转换，然后再发送到wsl内网中

2. mirror mode直接向宿主机真实网卡申请ip地址，共享同一个物理接口，仅虚拟同一网段不同ip，属于一个子网，但需要win11以上的特定版本


## 通过wsl默认网关访问宿主机服务的原理

```bash
[WSL2 Linux]
  eth0: 172.23.109.38
        |
        |  默认网关 172.23.96.1
        v
[Windows 虚拟网卡 vEthernet (WSL)]
  IP: 172.23.96.1
        |
        |  WinNAT 转发
        v
[物理网络 / 外网]
```

wsl通过访问默认网关，来访问win服务，但并不是直接的win localhost的映射
可以理解为 win 首先创建一个特殊虚拟ip，从虚拟ip里接收到的数据包，在宿主机tcp/ip协议中拥有直通权限，内核将其识别为虚拟网段ip，会将数据包转发到对于服务

gpt:
Windows NAT/Hyper-V 虚拟交换机 会自动创建一个**“宿主机在 NAT 子网中的 IP”**，这个就是 172.23.96.1。这个网关地址 直接映射到 Windows 内核 TCP/IP 堆栈：
当 WSL2 发送 TCP/UDP 包到 172.23.96.1:<port> 时，
WinNAT 会检测目标 IP 在这个虚拟网段内，
并把包直接送给 Windows 的服务监听端口，无需额外端口映射。
这个机制类似 “桥接 + 内核代理”：
对于 WSL2，172.23.96.1 看起来就是网关；
对 Windows，收到的包源 IP 是 WSL 虚拟 IP（如 172.23.109.38），目标 IP 是宿主机虚拟 IP（172.23.96.1）；
Windows 内核识别到这是本地虚拟网卡的流量，就直接交给对应的服务处理。
所以说：
WSL2 与宿主机的 NAT 网络不是普通的路由 NAT，而是 WinNAT + 虚拟网卡内核直通，因此访问 172.23.96.1 就像访问 localhost 一样简单。
172.23.96.1 并不是普通网关，它是 WSL2 与 Windows 内核 TCP/IP 栈的专用桥接地址；
访问它就等于访问宿主机服务，因为 WinNAT 自动做了内部转发；

## 宿主机访问本机wsl服务的原理

首先宿主机本身是可以直接访问wsl虚拟网卡地址的

```bash
#win
ping 172.23.109.38
#wsl
python3 -m http.serve 8081
#win
curl http://172.23.109.38:8081
```

需要宿主机增加一层代理，即用自己的真实ip代理wsl虚拟ip，然后进行端口映射，外部局域网网络通过对方机器的真实ip+目标端口进行访问
wsl2本身的虚拟网卡地址 172.23.109.38 对于宿主机来说是可以直接访问的，因为其内核进行了直通处理，但是其他机器是无法访问的

如果win宿主机代理端口被本机服务占用，那么流量接受时的转发优先级：
        1. 该端口未设置proxy的会将流量仅转发给win本地服务
        2. 设置了proxy代理，通常会提示失败，表示端口冲突

案例分析
在wsl开启一个8081的http服务
在win端查询监听
发现宿主机在监听回环8081
原因：wsl上创建的服务`0.0.0.0:8081`的同时，在宿主机上会被创建一条对应的映射规则`127.0.0.1:8081`，并且将监听到的流量转发到wsl上
那么是谁执行了这些规则的创建？
LxssManager 服务（运行在 Windows 上的系统服务）
👇
由它通过 Hyper-V NAT API 创建虚拟网络与端口映射
它以 LocalSystem 权限运行（等价于 root 权限），
能够访问 Windows 的虚拟网络栈和 Hyper-V API；
当你执行 wsl.exe 启动发行版时，LxssManager 会：
调用 Hyper-V 创建/恢复对应的轻量虚拟机；
连接虚拟交换机（vEthernet (WSL)）；
调用 Windows NAT API，注册端口反射规则；
真正执行 “网络桥接 + NAT + 端口转发” 的不是 Linux，而是 Windows 的 LxssManager 服务
在 WSL 子系统中启动 init（Linux PID 1）。

```bash
┌──────────────────────────────┐
│        Windows 内核 (NT)      │
│ ┌──────────────────────────┐ │
│ │ Hyper-V Platform (虚拟层) │ │
│ └──────────────────────────┘ │
│      ↑             ↑          │
│  vEthernet(WSL)   NAT组件      │
│      │             │          │
│ ┌──────────────────────────┐ │
│ │    WSL2 VM (轻量虚拟机)   │ │
│ │   ├─ Linux Kernel (MS定制)│ │
│ │   ├─ init(LxssManagerd)   │ │
│ │   └─ 你的Linux系统        │ │
│ └──────────────────────────┘ │
└──────────────────────────────┘

```

```bash
PS C:\WINDOWS\system32> netstat -ano | findstr :8081
  TCP    127.0.0.1:8081         0.0.0.0:0              LISTENING       2644
```

所以这一过程的机制与win本身netsh服务的端口转发差异？

内核级别
Hyper-V NAT 驱动层的端口转发
是在内核网络层直接修改数据包目标ip地址的操作
直接映射lockhost，仅映射了端口

用户态 TCP 代理
将宿主机任意 IP+端口映射到目标 ip

## 局域网内跨端机器间的wsl2通信方案

### 默认NAT模式下

### 配置wsl桥接网咯

### 高版本系统下，配置wsl使用镜像网络模式

TODO
